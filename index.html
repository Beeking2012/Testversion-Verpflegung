<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feldk√ºche - SEG Verpflegung</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            background-color: #f5f5f5;
            color: #333;
        }

        /* Kopfleiste */
        .navbar {
            background: #2c3e50;
            color: white;
            padding: 1rem 0;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }

        .nav-title {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .nav-link:hover,
        .nav-link.active {
            background-color: #34495e;
        }

        /* Hauptinhalt */
        .content {
            margin-top: 80px;
            min-height: calc(100vh - 80px);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Filter-Sektion */
        .filter-section {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-group label {
            font-weight: bold;
            font-size: 0.9rem;
        }

        select, input[type="number"], input[type="text"], input[type="date"] {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .personen-input {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .personen-input label {
            font-weight: bold;
            margin-right: 1rem;
        }

        .personen-input input {
            width: 120px;
        }

        /* Rezepte Grid */
        .rezepte-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .rezept-karte {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            border: 2px solid transparent;
        }

        .rezept-karte:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .rezept-karte.ausgewaehlt {
            border-color: #3498db;
            background-color: #f8f9fa;
        }

        .rezept-karte h4 {
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .rezept-info {
            display: flex;
            gap: 1rem;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }

        .rezept-beschreibung {
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 0.5rem;
        }

        /* Rezept Details */
        .rezept-details {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .rezept-header {
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 1rem;
            margin-bottom: 2rem;
        }

        .rezept-header h3 {
            color: #2c3e50;
            font-size: 1.8rem;
            margin-bottom: 1rem;
        }

        .rezept-meta {
            display: flex;
            gap: 2rem;
            font-size: 0.9rem;
            color: #7f8c8d;
            flex-wrap: wrap;
        }

        .rezept-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 3rem;
        }

        .zutaten-section h4,
        .zubereitung-section h4,
        .portionierung-section h4 {
            color: #2c3e50;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .zutaten-section h4 {
            border-bottom: 2px solid #3498db;
            padding-bottom: 0.5rem;
        }

        .zutaten-section ul {
            list-style: none;
            padding: 0;
        }

        .zutaten-section li {
            padding: 0.75rem 0;
            border-bottom: 1px solid #ecf0f1;
            font-size: 1rem;
        }

        .zutaten-section li:last-child {
            border-bottom: none;
        }

        .zubereitung-section ol {
            padding-left: 1.5rem;
        }

        .zubereitung-section li {
            padding: 0.75rem 0;
            margin-bottom: 0.5rem;
            line-height: 1.6;
            border-bottom: 1px solid #f8f9fa;
        }

        .portionierung-section {
            grid-column: 1 / -1;
            background: #e8f4f8;
            padding: 1.5rem;
            border-radius: 6px;
            margin-top: 1rem;
            border-left: 4px solid #3498db;
        }

        .portionierung-section h4 {
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .portionierung-section p {
            line-height: 1.6;
            margin: 0;
        }

        .rezept-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid #ecf0f1;
        }

        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }

        button:hover {
            background: #2980b9;
        }

        button.secondary {
            background: #95a5a6;
        }

        button.secondary:hover {
            background: #7f8c8d;
        }

        button.success {
            background: #27ae60;
        }

        button.success:hover {
            background: #219a52;
        }

        button.warning {
            background: #e67e22;
        }

        button.warning:hover {
            background: #d35400;
        }

        button.danger {
            background: #e74c3c;
        }

        button.danger:hover {
            background: #c0392b;
        }

        /* Einkaufsliste */
        .einkaufsliste-optionen {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .einkaufsliste-optionen label {
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .einkaufsliste-optionen input[type="radio"] {
            margin: 0;
        }

        .einkaufsliste-info {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .einkaufsliste-info p {
            margin: 0;
            font-size: 1.1rem;
        }

        .einkaufsliste-info p strong {
            color: #2c3e50;
        }

        .einkaufsliste-container {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .einkaufsliste-container h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 0.5rem;
        }

        .einkaufsliste-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #ecf0f1;
            align-items: center;
        }

        .einkaufsliste-item:last-child {
            border-bottom: none;
        }

        .einkaufsliste-item span:first-child {
            font-weight: 500;
        }

        .einkaufsliste-item span:last-child {
            color: #3498db;
            font-weight: bold;
        }

        .einkaufsliste-item.aus-lager {
            background-color: #e8f6f3;
            border-left: 4px solid #27ae60;
            padding-left: 1rem;
        }

        .einkaufsliste-item.aus-lager span:first-child {
            text-decoration: line-through;
            color: #7f8c8d;
        }

        .einkaufsliste-item.aus-lager::after {
            content: "‚úì Aus Lager";
            background: #27ae60;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-left: 1rem;
        }

        .lager-hinweis {
            background: #e8f4f8;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
            border-left: 4px solid #3498db;
            font-size: 0.9rem;
        }

        /* Lager-Styles */
        .lager-tabs {
            display: flex;
            margin-bottom: 1rem;
            border-bottom: 2px solid #ecf0f1;
        }

        .lager-tab {
            padding: 1rem 2rem;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .lager-tab.active {
            background: white;
            border-bottom-color: #3498db;
            font-weight: bold;
        }

        .lager-tab.lebensmittel.active {
            border-bottom-color: #27ae60;
        }

        .lager-tab.material.active {
            border-bottom-color: #e67e22;
        }

        .lager-controls {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .lager-form {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: end;
            flex: 1;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-weight: bold;
            font-size: 0.9rem;
        }

        .lager-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .lager-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .lager-table th,
        .lager-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        .lager-table th {
            background: #34495e;
            color: white;
            font-weight: 600;
        }

        .lager-table tr:hover {
            background: #f8f9fa;
        }

        .lager-table .low-stock {
            background: #ffeaa7;
        }

        .lager-table .critical-stock {
            background: #fab1a0;
        }

        .lager-table .expired {
            background: #ff7675;
        }

        .lager-table .expiring-soon {
            background: #ffeaa7;
        }

        .lager-actions {
            display: flex;
            gap: 0.5rem;
        }

        .lager-actions button {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
        }

        .menge-input {
            width: 80px;
            padding: 0.3rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }

        .lager-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card h3 {
            color: #2c3e50;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .stat-card .number {
            font-size: 2rem;
            font-weight: bold;
            color: #3498db;
        }

        .stat-card.warning .number {
            color: #e67e22;
        }

        .stat-card.critical .number {
            color: #e74c3c;
        }

        .keine-rezepte {
            text-align: center;
            padding: 2rem;
            background: white;
            border-radius: 8px;
            color: #666;
        }

        /* Seiten werden standardm√§√üig ausgeblendet */
        .page {
            display: none;
        }

        /* Nur die aktive Seite wird angezeigt */
        .page.active {
            display: block;
        }

        /* DRUCK-STYLES */
        @media print {
            body * {
                visibility: hidden;
            }
            
            #druck-rezept-container,
            #druck-einkaufsliste-container,
            #druck-rezept-container *,
            #druck-einkaufsliste-container * {
                visibility: visible !important;
                display: block !important;
            }
            
            #druck-rezept-container,
            #druck-einkaufsliste-container {
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                background: white !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            .navbar,
            .rezept-actions,
            .einkaufsliste-info,
            .filter-section,
            .personen-input,
            .rezepte-grid,
            .rezept-details,
            #einkaufsliste-content,
            .container {
                display: none !important;
                visibility: hidden !important;
            }
            
            body {
                background: white !important;
                font-size: 10pt !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            h1, h2, h3 {
                color: #000 !important;
                page-break-after: avoid;
            }
            
            table {
                page-break-inside: avoid;
            }
            
            ol, ul {
                page-break-inside: avoid;
            }
        }

        .druck-container {
            display: none;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .nav-container {
                flex-direction: column;
                gap: 1rem;
            }
            
            .container {
                padding: 1rem;
            }
            
            .filter-section {
                flex-direction: column;
                align-items: stretch;
            }
            
            .rezept-content {
                grid-template-columns: 1fr;
                gap: 2rem;
            }
            
            .rezepte-grid {
                grid-template-columns: 1fr;
            }
            
            .einkaufsliste-info {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
            }
            
            .rezept-actions {
                flex-direction: column;
            }
            
            .rezept-meta {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .lager-form {
                flex-direction: column;
                align-items: stretch;
            }
            
            .lager-table {
                overflow-x: auto;
            }
            
            .lager-actions {
                flex-direction: column;
            }
            
            .lager-tabs {
                flex-direction: column;
            }
            
            .lager-tab {
                padding: 0.75rem 1rem;
            }
            
            .einkaufsliste-optionen {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }
        }
        
        @media (max-width: 480px) {
            .nav-title {
                font-size: 1.2rem;
            }
            
            .nav-links {
                gap: 1rem;
            }
            
            .nav-link {
                padding: 0.4rem 0.8rem;
                font-size: 0.9rem;
            }
            
            .container {
                padding: 0.5rem;
            }
            
            .rezept-karte {
                padding: 1rem;
            }
            
            .rezept-details {
                padding: 1rem;
            }
            
            .rezept-content {
                gap: 1.5rem;
            }
            
            button {
                padding: 0.6rem 1.2rem;
                font-size: 0.9rem;
            }
            
            .lager-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Kopfleiste -->
    <nav class="navbar">
        <div class="nav-container">
            <h1 class="nav-title">SEG Feldk√ºche</h1>
            <div class="nav-links">
                <a href="#rezepte" class="nav-link active" data-page="rezepte">Rezepte</a>
                <a href="#einkaufsliste" class="nav-link" data-page="einkaufsliste">Einkaufsliste</a>
                <a href="#lager" class="nav-link" data-page="lager">Lager</a>
            </div>
        </div>
    </nav>

    <main class="content">
        <!-- Rezept-Seite -->
        <div id="rezepte" class="page active">
            <div class="container">
                <h2>Rezeptauswahl SEG Verpflegung</h2>
                
                <!-- Filter-Optionen -->
                <div class="filter-section">
                    <div class="filter-group">
                        <label>Verpflegungsart:</label>
                        <select id="verpflegungsart">
                            <option value="">Alle</option>
                            <option value="warm">Warmverpflegung</option>
                            <option value="kalt">Kaltverpflegung</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>Verpflegungstyp:</label>
                        <select id="verpflegungstyp">
                            <option value="">Alle</option>
                            <option value="voll">Vollverpflegung</option>
                            <option value="lunch">Lunchpakete</option>
                            <option value="hand">Handverpflegung</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>
                            <input type="checkbox" id="vegetarisch">
                            Nur vegetarische Rezepte
                        </label>
                    </div>
                </div>

                <!-- Personenanzahl -->
                <div class="personen-input">
                    <label for="personen">Personenanzahl:</label>
                    <input type="number" id="personen" min="1" max="400" value="50">
                    <small>Basis: 50 Personen f√ºr SEG-Einsatz</small>
                </div>

                <!-- Rezepte Grid -->
                <div class="rezepte-grid" id="rezepte-grid">
                    <!-- Rezepte werden hier dynamisch eingef√ºgt -->
                </div>

                <!-- Ausgew√§hltes Rezept -->
                <div id="rezept-details" class="rezept-details" style="display: none;">
                    <div class="rezept-header">
                        <h3 id="rezept-titel"></h3>
                        <div class="rezept-meta">
                            <span id="rezept-kalorien"></span>
                            <span id="rezept-zubereitungszeit"></span>
                            <span id="rezept-art"></span>
                        </div>
                    </div>
                    
                    <div class="rezept-content">
                        <div class="zutaten-section">
                            <h4>Zutaten f√ºr <span id="zutaten-personen">50</span> Personen</h4>
                            <ul id="rezept-zutaten"></ul>
                        </div>
                        
                        <div class="zubereitung-section">
                            <h4>Zubereitung</h4>
                            <ol id="rezept-zubereitung"></ol>
                        </div>
                        
                        <div class="portionierung-section">
                            <h4>Portionierung & Getr√§nke</h4>
                            <p id="rezept-portionierung"></p>
                        </div>
                    </div>
                    
                    <div class="rezept-actions">
                        <button onclick="exportRezeptPDF()">Rezept als PDF exportieren</button>
                        <button onclick="zurEinkaufsliste()">Zur Einkaufsliste</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Einkaufsliste-Seite -->
        <div id="einkaufsliste" class="page">
            <div class="container">
                <h2>Einkaufsliste</h2>
                
                <!-- Einkaufslisten-Optionen -->
                <div class="einkaufsliste-optionen">
                    <label>
                        <input type="radio" name="lager-option" value="alles-kaufen" checked onchange="aktualisiereEinkaufsliste()">
                        Alles neu kaufen (Lager ignorieren)
                    </label>
                    <label>
                        <input type="radio" name="lager-option" value="lager-verwenden" onchange="aktualisiereEinkaufsliste()">
                        Lager verwenden (Vorhandenes abziehen)
                    </label>
                </div>
                
                <div class="einkaufsliste-info">
                    <p>F√ºr <span id="einkauf-personen">50</span> Personen | 
                       <strong id="einkauf-rezept-titel">Kein Rezept ausgew√§hlt</strong>
                    </p>
                    <div>
                        <button onclick="exportEinkaufslistePDF()">Einkaufsliste als PDF exportieren</button>
                        <button onclick="showPage('rezepte')">Zur√ºck zu Rezepten</button>
                    </div>
                </div>
                
                <div id="einkaufsliste-content">
                    <p>Bitte w√§hle zuerst ein Rezept auf der Rezept-Seite aus.</p>
                </div>
            </div>
        </div>

        <!-- Lager-Seite -->
        <div id="lager" class="page">
            <div class="container">
                <h2>Lagerverwaltung</h2>
                
                <!-- Lager-Tabs -->
                <div class="lager-tabs">
                    <button class="lager-tab lebensmittel active" onclick="wechselLagerTab('lebensmittel')">üçΩÔ∏è Lebensmittel</button>
                    <button class="lager-tab material" onclick="wechselLagerTab('material')">üõ†Ô∏è Material</button>
                </div>
                
                <!-- Lager-Statistiken -->
                <div class="lager-stats" id="lager-stats">
                    <!-- Statistiken werden dynamisch eingef√ºgt -->
                </div>

                <!-- Lager-Controls -->
                <div class="lager-controls">
                    <div class="lager-form" id="lager-form">
                        <!-- Formular wird je nach Tab dynamisch eingef√ºgt -->
                    </div>
                </div>

                <!-- Lager-Tabelle -->
                <div class="lager-table">
                    <table>
                        <thead id="lager-table-header">
                            <!-- Tabellenkopf wird dynamisch eingef√ºgt -->
                        </thead>
                        <tbody id="lager-tabelle">
                            <!-- Lagerdaten werden dynamisch eingef√ºgt -->
                        </tbody>
                    </table>
                </div>

                <!-- Lager-Aktionen -->
                <div class="rezept-actions">
                    <button onclick="lagerExportieren()">Aktuelles Lager als CSV exportieren</button>
                    <button class="secondary" onclick="lagerImportieren()">Lager importieren</button>
                    <button class="warning" onclick="lagerLeeren()">Aktuelles Lager zur√ºcksetzen</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Versteckte Druck-Container -->
    <div id="druck-rezept-container" class="druck-container" style="display: none;"></div>
    <div id="druck-einkaufsliste-container" class="druck-container" style="display: none;"></div>

    <!-- Versteckter Datei-Input f√ºr Import -->
    <input type="file" id="lager-import-file" accept=".csv" style="display: none;">

    <script>
        // Upstash Redis Konfiguration
        const UPSTASH_CONFIG = {
            URL: "https://helping-cougar-30935.upstash.io",
            TOKEN: "AXjXAAIncDJhNzc0OTViMWEwZGI0MDdlYmRjNWFhOTYxYjRmNjVhYXAyMzA5MzU",
            READ_ONLY_TOKEN: "AnjXAAIgcDKLfeRS33kEwLSXH-5rwwYziTlTxrIHmmAT-n9rbo_Elg"
        };

        // Rezepte Daten (gek√ºrzt f√ºr bessere √úbersicht)
        const rezepteDaten = [
            {
                id: 1,
                titel: "SEG-Eintopf mit Rindfleisch",
                beschreibung: "Kraftvoller Eintopf f√ºr kalte Einsatztage",
                verpflegungsart: "warm",
                verpflegungstyp: "voll",
                vegetarisch: false,
                kalorien: 650,
                basisZeit: 60,
                zutaten: [
                    { menge: 7500, einheit: "g", name: "Rindfleisch, gew√ºrfelt" },
                    { menge: 50, einheit: "", name: "Kartoffeln, gew√ºrfelt" },
                    { menge: 30, einheit: "", name: "Karotten, in Scheiben" },
                    { menge: 20, einheit: "", name: "Zwiebeln, gew√ºrfelt" },
                    { menge: 10, einheit: "", name: "Sellerie, gew√ºrfelt" },
                    { menge: 200, einheit: "g", name: "Tomatenmark" },
                    { menge: 25, einheit: "l", name: "Rinderbr√ºhe" },
                    { menge: 100, einheit: "g", name: "Paprikapulver" },
                    { menge: 50, einheit: "g", name: "Majoran" },
                    { menge: 300, einheit: "ml", name: "√ñl" },
                    { menge: 100, einheit: "g", name: "Salz" },
                    { menge: 50, einheit: "g", name: "Pfeffer" }
                ],
                zubereitung: [
                    "Rindfleisch in gro√üen Bratent√∂pfen portionsweise scharf anbraten",
                    "Zwiebeln und Sellerie im Bratfond glasig d√ºnsten",
                    "Tomatenmark zugeben und kurz mitr√∂sten",
                    "Fleisch zur√ºck in den Topf geben, mit Br√ºhe abl√∂schen",
                    "Kartoffeln und Karotten hinzuf√ºgen, aufkochen lassen",
                    "Bei mittlerer Hitze 45 Minuten k√∂cheln lassen",
                    "Gew√ºrze zugeben und weitere 15 Minuten garen",
                    "Mit Salz und Pfeffer abschmecken"
                ],
                portionierung: "In Feldk√ºchen-Sch√ºsseln portionieren. Pro Person ca. 500ml Eintopf. Dazu 1 Liter Getr√§nke pro Person (Wasser, Apfelschorle im Verh√§ltnis 1:3). Mit frischem Brot servieren."
            },
            {
                id: 2,
                titel: "Nudelpfanne mit Gem√ºse und Tofu",
                beschreibung: "Vegetarische Pfanne f√ºr schnelle Verpflegung",
                verpflegungsart: "warm",
                verpflegungstyp: "voll",
                vegetarisch: true,
                kalorien: 580,
                basisZeit: 35,
                zutaten: [
                    { menge: 5000, einheit: "g", name: "Nudeln (Spiralnudeln)" },
                    { menge: 4000, einheit: "g", name: "Tofu, gew√ºrfelt" },
                    { menge: 30, einheit: "", name: "Zucchini, in Scheiben" },
                    { menge: 25, einheit: "", name: "Paprika, gew√ºrfelt" },
                    { menge: 20, einheit: "", name: "Zwiebeln, gew√ºrfelt" },
                    { menge: 400, einheit: "g", name: "Tomatenmark" },
                    { menge: 300, einheit: "ml", name: "Sojasauce" },
                    { menge: 200, einheit: "ml", name: "√ñl" },
                    { menge: 100, einheit: "g", name: "Knoblauch, gehackt" },
                    { menge: 80, einheit: "g", name: "Salz" },
                    { menge: 40, einheit: "g", name: "Pfeffer" },
                    { menge: 50, einheit: "g", name: "Paprikapulver" }
                ],
                zubereitung: [
                    "Nudeln in gro√üen T√∂pfen bissfest kochen, abgie√üen",
                    "Tofu in Bratpfannen goldbraun anbraten",
                    "Zwiebeln und Knoblauch in √ñl anschwitzen",
                    "Paprika und Zucchini zugeben, 5 Minuten braten",
                    "Tomatenmark und Gew√ºrze zugeben, kurz mitr√∂sten",
                    "Gekochte Nudeln und Tofu unterheben",
                    "Mit Sojasauce abschmecken, alles gut vermengen"
                ],
                portionierung: "In w√§rmeisolierten Beh√§ltern portionieren. Pro Person ca. 400g Nudelpfanne. Dazu 1 Liter Getr√§nke pro Person (Wasser, Tee). Mit Sojajoghurt oder geriebenem K√§se servieren."
            }
        ];

        // Globale Variablen
        let aktuellesRezept = null;
        let personenAnzahl = 50;
        let aktuellerLagerTab = 'lebensmittel';
        let lagerDaten = {
            lebensmittel: [],
            material: []
        };

        // NEUE FUNKTION: Findet Zutat im Lebensmittellager
        function findeZutatImLager(zutatName) {
            const lager = lagerDaten.lebensmittel;
            const gesuchterName = zutatName.toLowerCase();
            
            // Einfache Suche nach Teil√ºbereinstimmung
            for (let item of lager) {
                const lagerName = item.name.toLowerCase();
                
                // Direkte √úbereinstimmung oder Teil√ºbereinstimmung
                if (lagerName.includes(gesuchterName) || gesuchterName.includes(lagerName)) {
                    return item;
                }
                
                // Spezielle F√§lle f√ºr h√§ufige Zutaten
                if ((gesuchterName.includes('kartoffel') && lagerName.includes('kartoffel')) ||
                    (gesuchterName.includes('karotte') && lagerName.includes('karotte')) ||
                    (gesuchterName.includes('zwiebel') && lagerName.includes('zwiebel')) ||
                    (gesuchterName.includes('nudel') && lagerName.includes('nudel')) ||
                    (gesuchterName.includes('reis') && lagerName.includes('reis')) ||
                    (gesuchterName.includes('√∂l') && lagerName.includes('√∂l')) ||
                    (gesuchterName.includes('salz') && lagerName.includes('salz'))) {
                    return item;
                }
            }
            
            return null;
        }

        // NEUE FUNKTION: Berechnet ben√∂tigte Menge unter Ber√ºcksichtigung des Lagers
        function berechneBen√∂tigteMenge(rezeptZutat, lagerOption) {
            const skalierteMenge = (rezeptZutat.menge / 50) * personenAnzahl;
            
            if (lagerOption === 'alles-kaufen') {
                return {
                    ben√∂tigt: skalierteMenge,
                    ausLager: 0,
                    zuKaufen: skalierteMenge
                };
            }
            
            // Lager verwenden - pr√ºfe ob Zutat im Lager
            const lagerItem = findeZutatImLager(rezeptZutat.name);
            
            if (!lagerItem) {
                return {
                    ben√∂tigt: skalierteMenge,
                    ausLager: 0,
                    zuKaufen: skalierteMenge
                };
            }
            
            // Einheiten vergleichen und ggf. umrechnen
            let lagerMenge = lagerItem.menge;
            const rezeptEinheit = rezeptZutat.einheit || 'St√ºck';
            
            // Einheiten umrechnen falls n√∂tig
            if (rezeptEinheit !== lagerItem.einheit) {
                // Einfache Umrechnung f√ºr h√§ufige F√§lle
                if (rezeptEinheit === 'g' && lagerItem.einheit === 'kg') {
                    lagerMenge = lagerItem.menge * 1000;
                } else if (rezeptEinheit === 'kg' && lagerItem.einheit === 'g') {
                    lagerMenge = lagerItem.menge / 1000;
                } else if (rezeptEinheit === 'ml' && lagerItem.einheit === 'l') {
                    lagerMenge = lagerItem.menge * 1000;
                } else if (rezeptEinheit === 'l' && lagerItem.einheit === 'ml') {
                    lagerMenge = lagerItem.menge / 1000;
                }
                // F√ºr St√ºck vs. kg - schwierig umzurechnen, daher keine Umrechnung
            }
            
            const ausLager = Math.min(skalierteMenge, lagerMenge);
            const zuKaufen = Math.max(0, skalierteMenge - ausLager);
            
            return {
                ben√∂tigt: skalierteMenge,
                ausLager: ausLager,
                zuKaufen: zuKaufen,
                lagerItem: lagerItem
            };
        }

        // LAGER-FUNKTIONALIT√ÑT
        function wechselLagerTab(tab) {
            aktuellerLagerTab = tab;
            
            // Tabs aktivieren
            document.querySelectorAll('.lager-tab').forEach(tabElement => {
                tabElement.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Formular und Tabelle aktualisieren
            lagerFormularAktualisieren();
            lagerAnzeigen();
        }

        function lagerFormularAktualisieren() {
            const formContainer = document.getElementById('lager-form');
            
            if (aktuellerLagerTab === 'lebensmittel') {
                formContainer.innerHTML = `
                    <div class="form-group">
                        <label for="neues-item">Artikelname</label>
                        <input type="text" id="neues-item" placeholder="z.B. Kartoffeln">
                    </div>
                    <div class="form-group">
                        <label for="neue-kategorie">Kategorie</label>
                        <select id="neue-kategorie">
                            <option value="Gem√ºse">Gem√ºse</option>
                            <option value="Getreide">Getreide</option>
                            <option value="Konserven">Konserven</option>
                            <option value="Getr√§nke">Getr√§nke</option>
                            <option value="Gew√ºrze">Gew√ºrze</option>
                            <option value="Milchprodukte">Milchprodukte</option>
                            <option value="Fleisch">Fleisch</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="neue-einheit">Einheit</label>
                        <select id="neue-einheit">
                            <option value="kg">kg</option>
                            <option value="g">g</option>
                            <option value="l">l</option>
                            <option value="ml">ml</option>
                            <option value="St√ºck">St√ºck</option>
                            <option value="Dosen">Dosen</option>
                            <option value="Packungen">Packungen</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="neue-menge">Aktuelle Menge</label>
                        <input type="number" id="neue-menge" min="0" step="1" value="0">
                    </div>
                    <div class="form-group">
                        <label for="neue-mindestmenge">Mindestmenge</label>
                        <input type="number" id="neue-mindestmenge" min="0" step="1" value="0">
                    </div>
                    <div class="form-group">
                        <label for="neue-haltbarkeit">Haltbarkeit (MHD)</label>
                        <input type="date" id="neue-haltbarkeit">
                    </div>
                    <div class="form-group">
                        <label for="neue-lagerort">Lagerort</label>
                        <select id="neue-lagerort">
                            <option value="K√ºhlschrank">K√ºhlschrank</option>
                            <option value="Trockenlager">Trockenlager</option>
                            <option value="Tiefk√ºhl">Tiefk√ºhl</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button class="success" onclick="neuesLagerItem()">Hinzuf√ºgen</button>
                    </div>
                `;
            } else {
                formContainer.innerHTML = `
                    <div class="form-group">
                        <label for="neues-item">Artikelname</label>
                        <input type="text" id="neues-item" placeholder="z.B. Gaskartuschen">
                    </div>
                    <div class="form-group">
                        <label for="neue-kategorie">Kategorie</label>
                        <select id="neue-kategorie">
                            <option value="K√ºchenausstattung">K√ºchenausstattung</option>
                            <option value="Verbrauchsmaterial">Verbrauchsmaterial</option>
                            <option value="Sicherheit">Sicherheit</option>
                            <option value="Reinigung">Reinigung</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="neue-einheit">Einheit</label>
                        <select id="neue-einheit">
                            <option value="St√ºck">St√ºck</option>
                            <option value="Packungen">Packungen</option>
                            <option value="Flaschen">Flaschen</option>
                            <option value="Kanister">Kanister</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="neue-menge">Aktuelle Menge</label>
                        <input type="number" id="neue-menge" min="0" step="1" value="0">
                    </div>
                    <div class="form-group">
                        <label for="neue-mindestmenge">Mindestmenge</label>
                        <input type="number" id="neue-mindestmenge" min="0" step="1" value="0">
                    </div>
                    <div class="form-group">
                        <label for="neue-lagerort">Lagerort</label>
                        <select id="neue-lagerort">
                            <option value="Lagerraum A">Lagerraum A</option>
                            <option value="Lagerraum B">Lagerraum B</option>
                            <option value="Feldk√ºchen-Anh√§nger">Feldk√ºchen-Anh√§nger</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button class="success" onclick="neuesLagerItem()">Hinzuf√ºgen</button>
                    </div>
                `;
            }
        }

        // LAGER-FUNKTIONEN
        async function lagerDatenLaden() {
            try {
                console.log('Lade Lagerdaten von Upstash...');
                
                const response = await fetch(`${UPSTASH_CONFIG.URL}/get/lager`, {
                    headers: {
                        'Authorization': `Bearer ${UPSTASH_CONFIG.TOKEN}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.result) {
                    lagerDaten = JSON.parse(data.result);
                    console.log('Lagerdaten erfolgreich geladen:', lagerDaten);
                } else {
                    // Fallback: Standard-Lagerdaten
                    lagerDaten = {
                        lebensmittel: [
                            { name: "Kartoffeln", kategorie: "Gem√ºse", einheit: "kg", menge: 100, mindestmenge: 50, haltbarkeit: "2024-12-31", lagerort: "Trockenlager" },
                            { name: "Nudeln", kategorie: "Getreide", einheit: "kg", menge: 50, mindestmenge: 25, haltbarkeit: "2025-06-30", lagerort: "Trockenlager" },
                            { name: "√ñl", kategorie: "Gew√ºrze", einheit: "l", menge: 20, mindestmenge: 10, haltbarkeit: "2025-03-15", lagerort: "Trockenlager" }
                        ],
                        material: [
                            { name: "Gaskartuschen", kategorie: "K√ºchenausstattung", einheit: "St√ºck", menge: 10, mindestmenge: 5, lagerort: "Feldk√ºchen-Anh√§nger" },
                            { name: "Einweggeschirr", kategorie: "Verbrauchsmaterial", einheit: "Packungen", menge: 20, mindestmenge: 10, lagerort: "Lagerraum A" },
                            { name: "Desinfektionsmittel", kategorie: "Reinigung", einheit: "Flaschen", menge: 15, mindestmenge: 8, lagerort: "Lagerraum B" }
                        ]
                    };
                }
                
                lagerFormularAktualisieren();
                lagerAnzeigen();
                
            } catch (error) {
                console.error('Fehler beim Laden der Lagerdaten:', error);
                // Fallback zu localStorage
                const localData = localStorage.getItem('lagerDaten');
                if (localData) {
                    lagerDaten = JSON.parse(localData);
                } else {
                    // Standard-Lagerdaten
                    lagerDaten = {
                        lebensmittel: [
                            { name: "Kartoffeln", kategorie: "Gem√ºse", einheit: "kg", menge: 100, mindestmenge: 50, haltbarkeit: "2024-12-31", lagerort: "Trockenlager" },
                            { name: "Nudeln", kategorie: "Getreide", einheit: "kg", menge: 50, mindestmenge: 25, haltbarkeit: "2025-06-30", lagerort: "Trockenlager" }
                        ],
                        material: [
                            { name: "Gaskartuschen", kategorie: "K√ºchenausstattung", einheit: "St√ºck", menge: 10, mindestmenge: 5, lagerort: "Feldk√ºchen-Anh√§nger" },
                            { name: "Einweggeschirr", kategorie: "Verbrauchsmaterial", einheit: "Packungen", menge: 20, mindestmenge: 10, lagerort: "Lagerraum A" }
                        ]
                    };
                }
                lagerFormularAktualisieren();
                lagerAnzeigen();
            }
        }

        async function lagerDatenSpeichern() {
            try {
                const response = await fetch(`${UPSTASH_CONFIG.URL}/set/lager`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${UPSTASH_CONFIG.TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(JSON.stringify(lagerDaten))
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                await response.json();
                
            } catch (error) {
                console.error('Fehler beim Speichern der Lagerdaten:', error);
                // Fallback zu localStorage
                localStorage.setItem('lagerDaten', JSON.stringify(lagerDaten));
            }
        }

        function lagerAnzeigen() {
            const tabelle = document.getElementById('lager-tabelle');
            const header = document.getElementById('lager-table-header');
            const statsContainer = document.getElementById('lager-stats');
            const aktuellesLager = lagerDaten[aktuellerLagerTab];
            
            if (!tabelle || !header || !statsContainer) return;
            
            // Tabellenkopf je nach Lager-Typ
            if (aktuellerLagerTab === 'lebensmittel') {
                header.innerHTML = `
                    <tr>
                        <th>Artikel</th>
                        <th>Kategorie</th>
                        <th>Einheit</th>
                        <th>Menge</th>
                        <th>Mindestmenge</th>
                        <th>Haltbarkeit</th>
                        <th>Lagerort</th>
                        <th>Status</th>
                        <th>Aktionen</th>
                    </tr>
                `;
            } else {
                header.innerHTML = `
                    <tr>
                        <th>Artikel</th>
                        <th>Kategorie</th>
                        <th>Einheit</th>
                        <th>Menge</th>
                        <th>Mindestmenge</th>
                        <th>Lagerort</th>
                        <th>Status</th>
                        <th>Aktionen</th>
                    </tr>
                `;
            }
            
            // Statistiken berechnen
            const gesamtArtikel = aktuellesLager.length;
            const niedrigerBestand = aktuellesLager.filter(item => item.menge < item.mindestmenge).length;
            const kritischerBestand = aktuellesLager.filter(item => item.menge < item.mindestmenge * 0.5).length;
            
            // Statistiken anzeigen
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <h3>Gesamtartikel</h3>
                    <div class="number">${gesamtArtikel}</div>
                </div>
                <div class="stat-card ${niedrigerBestand > 0 ? 'warning' : ''}">
                    <h3>Niedriger Bestand</h3>
                    <div class="number">${niedrigerBestand}</div>
                </div>
                <div class="stat-card ${kritischerBestand > 0 ? 'critical' : ''}">
                    <h3>Kritischer Bestand</h3>
                    <div class="number">${kritischerBestand}</div>
                </div>
            `;
            
            // Tabelle f√ºllen
            tabelle.innerHTML = aktuellesLager.map((item, index) => {
                let statusKlasse = '';
                let statusText = 'OK';
                
                if (item.menge < item.mindestmenge * 0.5) {
                    statusKlasse = 'critical-stock';
                    statusText = 'Kritisch';
                } else if (item.menge < item.mindestmenge) {
                    statusKlasse = 'low-stock';
                    statusText = 'Niedrig';
                }
                
                // F√ºr Lebensmittel: Haltbarkeit pr√ºfen
                if (aktuellerLagerTab === 'lebensmittel' && item.haltbarkeit) {
                    const heute = new Date();
                    const haltbarkeit = new Date(item.haltbarkeit);
                    const tageBisAblauf = Math.ceil((haltbarkeit - heute) / (1000 * 60 * 60 * 24));
                    
                    if (tageBisAblauf < 0) {
                        statusKlasse = 'expired';
                        statusText = 'Abgelaufen';
                    } else if (tageBisAblauf <= 30) {
                        statusKlasse = 'expiring-soon';
                        statusText = `L√§uft in ${tageBisAblauf} Tagen ab`;
                    }
                }
                
                const haltbarkeitText = item.haltbarkeit ? new Date(item.haltbarkeit).toLocaleDateString('de-DE') : '-';
                
                if (aktuellerLagerTab === 'lebensmittel') {
                    return `
                        <tr class="${statusKlasse}">
                            <td>${item.name}</td>
                            <td>${item.kategorie}</td>
                            <td>${item.einheit}</td>
                            <td>
                                <input type="number" class="menge-input" value="${item.menge}" 
                                       onchange="mengeDirektAendern(${index}, this.value)"
                                       min="0">
                            </td>
                            <td>${item.mindestmenge}</td>
                            <td>${haltbarkeitText}</td>
                            <td>${item.lagerort}</td>
                            <td>${statusText}</td>
                            <td class="lager-actions">
                                <button onclick="lagerItemLoeschen(${index})" class="danger">L√∂schen</button>
                            </td>
                        </tr>
                    `;
                } else {
                    return `
                        <tr class="${statusKlasse}">
                            <td>${item.name}</td>
                            <td>${item.kategorie}</td>
                            <td>${item.einheit}</td>
                            <td>
                                <input type="number" class="menge-input" value="${item.menge}" 
                                       onchange="mengeDirektAendern(${index}, this.value)"
                                       min="0">
                            </td>
                            <td>${item.mindestmenge}</td>
                            <td>${item.lagerort}</td>
                            <td>${statusText}</td>
                            <td class="lager-actions">
                                <button onclick="lagerItemLoeschen(${index})" class="danger">L√∂schen</button>
                            </td>
                        </tr>
                    `;
                }
            }).join('');
        }

        async function neuesLagerItem() {
            const nameInput = document.getElementById('neues-item');
            const kategorieInput = document.getElementById('neue-kategorie');
            const einheitInput = document.getElementById('neue-einheit');
            const mengeInput = document.getElementById('neue-menge');
            const mindestmengeInput = document.getElementById('neue-mindestmenge');
            const lagerortInput = document.getElementById('neue-lagerort');
            
            const name = nameInput.value.trim();
            const kategorie = kategorieInput.value;
            const einheit = einheitInput.value;
            const menge = parseInt(mengeInput.value);
            const mindestmenge = parseInt(mindestmengeInput.value);
            const lagerort = lagerortInput.value;
            
            if (!name || isNaN(menge) || isNaN(mindestmenge)) {
                alert('Bitte f√ºllen Sie alle Pflichtfelder korrekt aus.');
                return;
            }
            
            const neuesItem = {
                name,
                kategorie,
                einheit,
                menge,
                mindestmenge,
                lagerort
            };
            
            // Zus√§tzliche Felder f√ºr Lebensmittel
            if (aktuellerLagerTab === 'lebensmittel') {
                const haltbarkeitInput = document.getElementById('neue-haltbarkeit');
                neuesItem.haltbarkeit = haltbarkeitInput.value || null;
            }
            
            lagerDaten[aktuellerLagerTab].push(neuesItem);
            await lagerDatenSpeichern();
            lagerAnzeigen();
            
            // Formular zur√ºcksetzen
            nameInput.value = '';
            mengeInput.value = '0';
            mindestmengeInput.value = '0';
            if (aktuellerLagerTab === 'lebensmittel') {
                document.getElementById('neue-haltbarkeit').value = '';
            }
        }

        async function mengeDirektAendern(index, neueMenge) {
            const aktuellesLager = lagerDaten[aktuellerLagerTab];
            if (index < 0 || index >= aktuellesLager.length) return;
            
            aktuellesLager[index].menge = parseInt(neueMenge) || 0;
            
            if (aktuellesLager[index].menge < 0) {
                aktuellesLager[index].menge = 0;
            }
            
            await lagerDatenSpeichern();
            lagerAnzeigen();
        }

        async function lagerItemLoeschen(index) {
            const aktuellesLager = lagerDaten[aktuellerLagerTab];
            if (confirm('M√∂chten Sie diesen Artikel wirklich l√∂schen?')) {
                aktuellesLager.splice(index, 1);
                await lagerDatenSpeichern();
                lagerAnzeigen();
            }
        }

        function lagerExportieren() {
            const aktuellesLager = lagerDaten[aktuellerLagerTab];
            const lagerTyp = aktuellerLagerTab === 'lebensmittel' ? 'Lebensmittel' : 'Material';
            
            let csvHeader, csvRows;
            
            if (aktuellerLagerTab === 'lebensmittel') {
                csvHeader = 'Artikel,Kategorie,Einheit,Menge,Mindestmenge,Haltbarkeit,Lagerort\n';
                csvRows = aktuellesLager.map(item => 
                    `"${item.name}","${item.kategorie}","${item.einheit}",${item.menge},${item.mindestmenge},"${item.haltbarkeit || ''}","${item.lagerort}"`
                ).join('\n');
            } else {
                csvHeader = 'Artikel,Kategorie,Einheit,Menge,Mindestmenge,Lagerort\n';
                csvRows = aktuellesLager.map(item => 
                    `"${item.name}","${item.kategorie}","${item.einheit}",${item.menge},${item.mindestmenge},"${item.lagerort}"`
                ).join('\n');
            }
            
            const csvContent = csvHeader + csvRows;
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            
            link.setAttribute('href', url);
            link.setAttribute('download', `${lagerTyp}_lager_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function lagerImportieren() {
            document.getElementById('lager-import-file').click();
        }

        async function lagerLeeren() {
            const lagerTyp = aktuellerLagerTab === 'lebensmittel' ? 'Lebensmittel' : 'Material';
            if (confirm(`M√∂chten Sie wirklich das ${lagerTyp}-Lager zur√ºcksetzen? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.`)) {
                lagerDaten[aktuellerLagerTab] = [];
                await lagerDatenSpeichern();
                lagerAnzeigen();
            }
        }

        // Event Listener f√ºr Datei-Import
        document.getElementById('lager-import-file').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvText = e.target.result;
                    const lines = csvText.split('\n');
                    const newLagerDaten = [];
                    
                    // Header √ºberspringen (erste Zeile)
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        const fields = line.split(',').map(field => 
                            field.replace(/^"|"$/g, '')
                        );
                        
                        if (fields[0] && fields[1]) {
                            const item = {
                                name: fields[0],
                                kategorie: fields[1],
                                einheit: fields[2],
                                menge: parseInt(fields[3]) || 0,
                                mindestmenge: parseInt(fields[4]) || 0,
                                lagerort: fields[6] || 'Standard'
                            };
                            
                            if (aktuellerLagerTab === 'lebensmittel' && fields[5]) {
                                item.haltbarkeit = fields[5];
                            }
                            
                            newLagerDaten.push(item);
                        }
                    }
                    
                    lagerDaten[aktuellerLagerTab] = newLagerDaten;
                    lagerDatenSpeichern();
                    lagerAnzeigen();
                    alert('Lager erfolgreich importiert!');
                    
                } catch (error) {
                    console.error('Fehler beim Importieren:', error);
                    alert('Fehler beim Importieren der CSV-Datei.');
                }
            };
            
            reader.readAsText(file);
            event.target.value = '';
        });

        // NEUE EINKAUFSLISTEN-FUNKTIONALIT√ÑT
        function aktualisiereEinkaufsliste() {
            document.getElementById('einkauf-personen').textContent = personenAnzahl;
            
            if (!aktuellesRezept) {
                document.getElementById('einkauf-rezept-titel').textContent = 'Kein Rezept ausgew√§hlt';
                document.getElementById('einkaufsliste-content').innerHTML = '<p>Bitte w√§hle zuerst ein Rezept auf der Rezept-Seite aus.</p>';
                return;
            }

            document.getElementById('einkauf-rezept-titel').textContent = aktuellesRezept.titel;
            
            const container = document.getElementById('einkaufsliste-content');
            const lagerOption = document.querySelector('input[name="lager-option"]:checked').value;
            
            let gesparteMenge = 0;
            let gesparteArtikel = 0;
            
            const einkaufslisteHTML = aktuellesRezept.zutaten.map(zutat => {
                const mengenBerechnung = berechneBen√∂tigteMenge(zutat, lagerOption);
                const { zuKaufen, ausLager, ben√∂tigt } = mengenBerechnung;
                
                if (ausLager > 0) {
                    gesparteMenge += ausLager;
                    gesparteArtikel++;
                }
                
                // Automatische Umrechnung f√ºr gro√üe Mengen
                let { menge: anzuzeigendeMenge, einheit: anzuzeigendeEinheit } = konvertiereZuFeldkueche(zuKaufen, zutat.einheit, zutat.name);
                const { menge: benoetigteMenge, einheit: benoetigteEinheit } = konvertiereZuFeldkueche(ben√∂tigt, zutat.einheit, zutat.name);
                const { menge: lagerMenge, einheit: lagerEinheit } = konvertiereZuFeldkueche(ausLager, zutat.einheit, zutat.name);
                
                if (lagerOption === 'alles-kaufen' || zuKaufen > 0) {
                    return `
                        <div class="einkaufsliste-item ${ausLager > 0 ? 'aus-lager' : ''}">
                            <span>${zutat.name}${ausLager > 0 ? ` (${lagerMenge} ${lagerEinheit} aus Lager)` : ''}</span>
                            <span>${anzuzeigendeMenge} ${anzuzeigendeEinheit}</span>
                        </div>
                    `;
                } else {
                    // Komplett aus Lager - wird durchgestrichen angezeigt
                    return `
                        <div class="einkaufsliste-item aus-lager">
                            <span>${zutat.name}</span>
                            <span>${benoetigteMenge} ${benoetigteEinheit}</span>
                        </div>
                    `;
                }
            }).join('');
            
            let hinweisHTML = '';
            if (lagerOption === 'lager-verwenden' && gesparteArtikel > 0) {
                hinweisHTML = `
                    <div class="lager-hinweis">
                        <strong>Lager verwendet:</strong> ${gesparteArtikel} Artikel mit insgesamt ${gesparteMenge.toFixed(1)} Einheiten werden aus dem Lager entnommen.
                    </div>
                `;
            }
            
            container.innerHTML = `
                <div class="einkaufsliste-container">
                    <h3>Zutaten ${lagerOption === 'lager-verwenden' ? '(mit Lagerabzug)' : '(komplett neu kaufen)'}</h3>
                    ${einkaufslisteHTML}
                    ${hinweisHTML}
                    <!-- Getr√§nke immer separat -->
                    <div class="einkaufsliste-item" style="background-color: #e8f4f8; margin-top: 10px; padding: 10px; border-radius: 4px;">
                        <span><strong>Getr√§nke (Wasser, Saftschorle)</strong></span>
                        <span><strong>${personenAnzahl} l</strong></span>
                    </div>
                </div>
            `;
        }

        // Automatische Umrechnung f√ºr Feldk√ºchen-Mengen
        function konvertiereZuFeldkueche(menge, einheit, zutatName) {
            const name = zutatName.toLowerCase();
            
            // F√ºr gro√üe Mengen (ab 1000) in kg/l umrechnen
            if (einheit === "g" && menge >= 1000) {
                return { menge: (menge / 1000).toFixed(1), einheit: "kg" };
            }
            if (einheit === "ml" && menge >= 1000) {
                return { menge: (menge / 1000).toFixed(1), einheit: "l" };
            }
            
            // F√ºr spezifische Zutaten automatisch passende Einheiten
            if (einheit === "" || einheit === "St√ºck") {
                if (name.includes('kartoffel') || name.includes('karotte') || name.includes('zwiebel') || 
                    name.includes('tomate') || name.includes('gurke') || name.includes('brokkoli') ||
                    name.includes('paprika') || name.includes('avocado') || name.includes('apfel') ||
                    name.includes('banane')) {
                    if (menge >= 10) {
                        return { menge: Math.round(menge), einheit: "kg" };
                    }
                }
            }
            
            // Standard: Einheit beibehalten, aber runden
            let angezeigteMenge = menge;
            if (menge % 1 !== 0) {
                angezeigteMenge = menge.toFixed(1);
            }
            
            // F√ºr leere Einheiten "St√ºck" anzeigen
            const finaleEinheit = einheit === "" ? "St√ºck" : einheit;
            
            return { menge: angezeigteMenge, einheit: finaleEinheit };
        }

        // Initialisierung
        document.addEventListener('DOMContentLoaded', function() {
            // Event Listener f√ºr Filter
            document.getElementById('verpflegungsart').addEventListener('change', filterRezepte);
            document.getElementById('verpflegungstyp').addEventListener('change', filterRezepte);
            document.getElementById('vegetarisch').addEventListener('change', filterRezepte);
            
            // Personenanzahl Event-Listener
            document.getElementById('personen').addEventListener('input', function() {
                personenAnzahl = parseInt(this.value) || 1;
                document.getElementById('zutaten-personen').textContent = personenAnzahl;
                document.getElementById('einkauf-personen').textContent = personenAnzahl;
                
                if (aktuellesRezept) {
                    zeigeAusgewaehltesRezept(aktuellesRezept.id);
                }
                
                aktualisiereEinkaufsliste();
            });

            // Navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const pageId = this.getAttribute('data-page');
                    showPage(pageId);
                });
            });

            // Startseite anzeigen
            showPage('rezepte');
            
            // Browser Navigation behandeln
            window.addEventListener('popstate', function() {
                const hash = window.location.hash.replace('#', '') || 'rezepte';
                showPage(hash);
            });

            const initialPage = window.location.hash.replace('#', '') || 'rezepte';
            showPage(initialPage);
            
            // Rezepte initial laden
            filterRezepte();
            
            // Lager initial laden
            lagerDatenLaden();
        });

        function showPage(pageId) {
            // Navigation aktualisieren
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('data-page') === pageId) {
                    link.classList.add('active');
                }
            });

            // Alle Seiten ausblenden
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
                page.style.display = 'none';
            });
            
            // Nur die gew√ºnschte Seite anzeigen
            const aktiveSeite = document.getElementById(pageId);
            if (aktiveSeite) {
                aktiveSeite.classList.add('active');
                aktiveSeite.style.display = 'block';
            }

            // URL aktualisieren
            window.history.pushState(null, null, `#${pageId}`);

            // Spezielle Aktionen pro Seite
            if (pageId === 'rezepte') {
                filterRezepte();
            } else if (pageId === 'einkaufsliste') {
                aktualisiereEinkaufsliste();
            } else if (pageId === 'lager') {
                lagerAnzeigen();
            }
        }

        function filterRezepte() {
            const verpflegungsart = document.getElementById('verpflegungsart').value;
            const verpflegungstyp = document.getElementById('verpflegungstyp').value;
            const nurVegetarisch = document.getElementById('vegetarisch').checked;

            const gefilterteRezepte = rezepteDaten.filter(rezept => {
                if (verpflegungsart && rezept.verpflegungsart !== verpflegungsart) return false;
                if (verpflegungstyp && rezept.verpflegungstyp !== verpflegungstyp) return false;
                if (nurVegetarisch && !rezept.vegetarisch) return false;
                return true;
            });

            const grid = document.getElementById('rezepte-grid');
            
            if (gefilterteRezepte.length === 0) {
                grid.innerHTML = '<div class="keine-rezepte">Keine Rezepte gefunden, die den Filterkriterien entsprechen.</div>';
                return;
            }

            grid.innerHTML = gefilterteRezepte.map(rezept => `
                <div class="rezept-karte" onclick="zeigeAusgewaehltesRezept(${rezept.id})">
                    <h4>${rezept.titel}</h4>
                    <div class="rezept-info">
                        <span>${rezept.kalorien} kcal/Person</span>
                        <span>${rezept.basisZeit} min (50 Pers.)</span>
                        <span>${rezept.vegetarisch ? 'Vegetarisch' : 'Mit Fleisch'}</span>
                    </div>
                    <p class="rezept-beschreibung">${rezept.beschreibung}</p>
                </div>
            `).join('');

            document.getElementById('rezept-details').style.display = 'none';
            aktuellesRezept = null;
        }

        function zeigeAusgewaehltesRezept(rezeptId) {
            const rezept = rezepteDaten.find(r => r.id === rezeptId);
            aktuellesRezept = rezept;

            if (!rezept) return;

            // Skalierte Zeit berechnen
            const skalierteZeit = Math.round(rezept.basisZeit * (personenAnzahl / 50));

            // Alle Rezept-Karten zur√ºcksetzen
            document.querySelectorAll('.rezept-karte').forEach(karte => {
                karte.classList.remove('ausgewaehlt');
            });

            // Aktuelle Karte markieren
            document.querySelectorAll('.rezept-karte').forEach(karte => {
                if (karte.querySelector('h4').textContent === rezept.titel) {
                    karte.classList.add('ausgewaehlt');
                }
            });

            // Personenanzahl anzeigen
            document.getElementById('zutaten-personen').textContent = personenAnzahl;

            // Details anzeigen
            document.getElementById('rezept-titel').textContent = rezept.titel;
            document.getElementById('rezept-kalorien').textContent = `${rezept.kalorien * personenAnzahl} kcal gesamt`;
            document.getElementById('rezept-zubereitungszeit').textContent = `${skalierteZeit} min Zubereitung`;
            document.getElementById('rezept-art').textContent = `${rezept.verpflegungsart === 'warm' ? 'Warm' : 'Kalt'} ‚Ä¢ ${rezept.verpflegungstyp === 'voll' ? 'Vollverpflegung' : rezept.verpflegungstyp === 'lunch' ? 'Lunchpakete' : 'Handverpflegung'} ‚Ä¢ ${rezept.vegetarisch ? 'Vegetarisch' : 'Mit Fleisch'}`;

            // Zutaten anzeigen
            const zutatenListe = document.getElementById('rezept-zutaten');
            zutatenListe.innerHTML = rezept.zutaten.map(zutat => {
                const skalierteMenge = (zutat.menge / 50) * personenAnzahl;
                const { menge, einheit } = konvertiereZuFeldkueche(skalierteMenge, zutat.einheit, zutat.name);
                
                return `<li>${menge} ${einheit} ${zutat.name}</li>`;
            }).join('');

            // Zubereitung anzeigen
            const zubereitungListe = document.getElementById('rezept-zubereitung');
            zubereitungListe.innerHTML = rezept.zubereitung.map(schritt => 
                `<li>${schritt}</li>`
            ).join('');

            // Portionierung anzeigen
            document.getElementById('rezept-portionierung').textContent = rezept.portionierung;

            // Details einblenden
            document.getElementById('rezept-details').style.display = 'block';
        }

        function zurEinkaufsliste() {
            if (aktuellesRezept) {
                showPage('einkaufsliste');
            } else {
                alert('Bitte w√§hle zuerst ein Rezept aus!');
            }
        }

        // PDF Export Funktionen (angepasst f√ºr Lagerintegration)
        function exportRezeptPDF() {
            if (!aktuellesRezept) {
                alert('Bitte w√§hle zuerst ein Rezept aus!');
                return;
            }
        
            const skalierteZeit = Math.round(aktuellesRezept.basisZeit * (personenAnzahl / 50));
            const druckContainer = document.getElementById('druck-rezept-container');
            
            const zutatenTabelle = aktuellesRezept.zutaten.map(zutat => {
                const skalierteMenge = (zutat.menge / 50) * personenAnzahl;
                const { menge, einheit } = konvertiereZuFeldkueche(skalierteMenge, zutat.einheit, zutat.name);
                
                return `
                    <tr>
                        <td style="padding: 4px 6px; border-bottom: 1px solid #ddd; font-size: 10pt;">${zutat.name}</td>
                        <td style="padding: 4px 6px; border-bottom: 1px solid #ddd; text-align: right; font-weight: bold; font-size: 10pt;">${menge} ${einheit}</td>
                    </tr>
                `;
            }).join('');
        
            const zubereitungListe = aktuellesRezept.zubereitung.map((schritt, index) => 
                `<li style="margin-bottom: 6px; line-height: 1.3; font-size: 10pt;">${schritt}</li>`
            ).join('');
        
            druckContainer.innerHTML = `
                <div class="druck-rezept" style="font-family: Arial, sans-serif; max-width: 700px; margin: 0 auto; padding: 15px; font-size: 10pt;">
                    <div style="border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 15px;">
                        <h1 style="color: #2c3e50; font-size: 16pt; margin-bottom: 8px; text-align: center;">${aktuellesRezept.titel}</h1>
                        <div style="display: flex; justify-content: center; gap: 15px; font-size: 9pt; color: #666; flex-wrap: wrap;">
                            <span><strong>${aktuellesRezept.kalorien * personenAnzahl} kcal</strong> gesamt</span>
                            <span><strong>${skalierteZeit} min</strong> Zubereitung</span>
                            <span>${aktuellesRezept.verpflegungsart === 'warm' ? 'Warm' : 'Kalt'} ‚Ä¢ ${aktuellesRezept.verpflegungstyp === 'voll' ? 'Vollverpflegung' : aktuellesRezept.verpflegungstyp === 'lunch' ? 'Lunchpakete' : 'Handverpflegung'} ‚Ä¢ ${aktuellesRezept.vegetarisch ? 'Vegetarisch' : 'Mit Fleisch'}</span>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h2 style="color: #2c3e50; font-size: 12pt; border-bottom: 1px solid #3498db; padding-bottom: 5px; margin-bottom: 10px;">
                            Zutaten f√ºr ${personenAnzahl} Personen
                        </h2>
                        <table style="width: 100%; border-collapse: collapse; font-size: 9pt;">
                            <thead>
                                <tr>
                                    <th style="padding: 6px 8px; border-bottom: 1px solid #3498db; text-align: left; background: #f8f9fa;">Zutat</th>
                                    <th style="padding: 6px 8px; border-bottom: 1px solid #3498db; text-align: right; background: #f8f9fa;">Menge</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${zutatenTabelle}
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h2 style="color: #2c3e50; font-size: 12pt; border-bottom: 1px solid #3498db; padding-bottom: 5px; margin-bottom: 10px;">
                            Zubereitung
                        </h2>
                        <ol style="padding-left: 15px; font-size: 10pt; line-height: 1.3;">
                            ${zubereitungListe}
                        </ol>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 3px; margin-top: 15px; border-left: 3px solid #3498db;">
                        <h3 style="color: #2c3e50; font-size: 11pt; margin-bottom: 5px;">Portionierung & Getr√§nke</h3>
                        <p style="line-height: 1.3; margin: 0; font-size: 9pt;">${aktuellesRezept.portionierung}</p>
                        <p style="line-height: 1.3; margin: 10px 0 0 0; font-size: 9pt; font-weight: bold;">Getr√§nke: ${personenAnzahl} Liter (Wasser, Saftschorle) - 1 Liter pro Person</p>
                    </div>

                    <div style="margin-top: 20px; padding-top: 10px; border-top: 1px solid #ddd; font-size: 8pt; color: #666; text-align: center;">
                        <p>Erstellt am: ${new Date().toLocaleString('de-DE')} | Quelle: SEG Feldk√ºche - Katastrophenschutz</p>
                    </div>
                </div>
            `;
        
            druckContainer.style.display = 'block';
            
            setTimeout(() => {
                window.print();
                
                setTimeout(() => {
                    druckContainer.style.display = 'none';
                    druckContainer.innerHTML = '';
                }, 500);
            }, 100);
        }
        
        function exportEinkaufslistePDF() {
            if (!aktuellesRezept) {
                alert('Bitte w√§hle zuerst ein Rezept aus!');
                return;
            }
        
            const druckContainer = document.getElementById('druck-einkaufsliste-container');
            const lagerOption = document.querySelector('input[name="lager-option"]:checked').value;
            
            const einkaufslisteHTML = aktuellesRezept.zutaten.map(zutat => {
                const mengenBerechnung = berechneBen√∂tigteMenge(zutat, lagerOption);
                const { zuKaufen, ausLager } = mengenBerechnung;
                
                const { menge: anzuzeigendeMenge, einheit: anzuzeigendeEinheit } = konvertiereZuFeldkueche(zuKaufen, zutat.einheit, zutat.name);
                const { menge: lagerMenge, einheit: lagerEinheit } = konvertiereZuFeldkueche(ausLager, zutat.einheit, zutat.name);
                
                if (lagerOption === 'alles-kaufen' || zuKaufen > 0) {
                    return `
                        <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #f5f5f5; font-size: 10pt;">
                            <span>${zutat.name}${ausLager > 0 ? ` (${lagerMenge} ${lagerEinheit} aus Lager)` : ''}</span>
                            <span style="color: #3498db; font-weight: bold;">${anzuzeigendeMenge} ${anzuzeigendeEinheit}</span>
                        </div>
                    `;
                } else {
                    return `
                        <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #f5f5f5; font-size: 10pt; background: #e8f6f3;">
                            <span style="text-decoration: line-through; color: #7f8c8d;">${zutat.name}</span>
                            <span style="color: #27ae60; font-weight: bold;">Aus Lager</span>
                        </div>
                    `;
                }
            }).join('');
            
            druckContainer.innerHTML = `
                <div style="font-family: Arial, sans-serif; max-width: 700px; margin: 0 auto; padding: 15px; font-size: 10pt;">
                    <div style="text-align: center; margin-bottom: 15px;">
                        <h2 style="font-size: 16pt; margin-bottom: 5px;">Einkaufsliste</h2>
                        <p style="font-size: 10pt;"><strong>${aktuellesRezept.titel}</strong> f√ºr ${personenAnzahl} Personen</p>
                        <p style="font-size: 9pt; color: #666;">Modus: ${lagerOption === 'alles-kaufen' ? 'Alles neu kaufen' : 'Lager verwenden'}</p>
                    </div>
                    
                    <div style="background: white; padding: 15px; margin-bottom: 12px; border-radius: 3px; border: 1px solid #eee;">
                        <h3 style="color: #2c3e50; font-size: 12pt; margin-bottom: 10px; border-bottom: 1px solid #ecf0f1; padding-bottom: 3px;">
                            Zutaten ${lagerOption === 'lager-verwenden' ? '(mit Lagerabzug)' : ''}
                        </h3>
                        ${einkaufslisteHTML}
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f5f5f5; font-size: 10pt; background: #e8f4f8; margin-top: 10px; padding: 10px; border-radius: 4px;">
                            <span style="font-weight: bold;">Getr√§nke (Wasser, Saftschorle)</span>
                            <span style="color: #3498db; font-weight: bold;">${personenAnzahl} l</span>
                        </div>
                    </div>

                    <div style="margin-top: 20px; padding-top: 10px; border-top: 1px solid #ddd; font-size: 8pt; color: #666; text-align: center;">
                        <p>Erstellt am: ${new Date().toLocaleString('de-DE')} | Quelle: SEG Feldk√ºche - Katastrophenschutz</p>
                    </div>
                </div>
            `;
        
            druckContainer.style.display = 'block';
            
            setTimeout(() => {
                window.print();
                
                setTimeout(() => {
                    druckContainer.style.display = 'none';
                    druckContainer.innerHTML = '';
                }, 500);
            }, 100);
        }
    </script>
</body>
</html>
